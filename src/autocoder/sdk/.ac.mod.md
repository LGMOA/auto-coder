
# Auto-Coder SDK

Auto-Coder SDK 是一个为第三方开发者提供的 Python SDK，允许通过命令行工具和 Python API 两种方式使用 Auto-Coder 的核心功能。SDK 版本：1.0.0

## 目录结构

```
src/autocoder/sdk/
├── __init__.py                 # SDK主入口，提供公共API
├── constants.py               # 常量定义（版本、默认值、配置选项等）
├── exceptions.py              # 自定义异常类
├── cli/                       # 命令行接口模块
│   ├── __init__.py
│   ├── __main__.py           # CLI模块入口点
│   ├── completion_wrapper.py # 自动补全包装器
│   ├── formatters.py         # 输出格式化器
│   ├── handlers.py           # 命令处理器（打印模式、会话模式）
│   ├── install_completion.py # 自动补全安装脚本
│   ├── main.py               # CLI主入口点
│   └── options.py            # CLI选项定义
├── core/                      # 核心功能模块
│   ├── __init__.py
│   ├── auto_coder_core.py    # AutoCoder核心封装类
│   └── bridge.py             # 桥接层，连接现有功能
├── models/                    # 数据模型
│   ├── __init__.py
│   ├── options.py            # 配置选项模型
│   ├── messages.py           # 消息模型
│   └── responses.py          # 响应模型
├── session/                   # 会话管理
│   ├── __init__.py
│   ├── session.py            # 单个会话类
│   └── session_manager.py    # 会话管理器
└── utils/                     # 工具函数
    ├── __init__.py
    ├── formatters.py         # 格式化工具
    ├── io_utils.py           # IO工具
    └── validators.py         # 验证工具
```

## 快速开始

### 0. 模型配置

编辑 `~/.auto-coder/keys/models.json` 文件，增加如下配置（这里是配置v3）：


```json
[
{
    "name": "deepseek/v3",
    "description": "DeepSeek Chat is for coding",
    "model_name": "deepseek-chat",
    "model_type": "saas/openai",
    "base_url": "https://api.deepseek.com/v1",
    "api_key_path": "api.deepseek.com",
    "is_reasoning": false,
    "input_price": 0,
    "output_price": 0,
    "average_speed": 0,
    "max_output_tokens": 8096,    
}
]
```

然后将 API KEY 放到同目录下的 `api.deepseek.com` 文件里即可。

后续你就可以使用名字 'deepseek/v3' 来引用这个模型了。

### 1. 项目初始化

在使用 Auto-Coder SDK 之前，建议先初始化项目，这会创建必要的配置文件和目录结构：

```python
from autocoder.sdk import init_project_if_required

# 初始化当前项目目录（Python 和 TypeScript 项目）
init_project_if_required(".", ".py,.ts")

# 初始化指定目录的 Java 项目
init_project_if_required("/path/to/project", ".java")

# 初始化 React 项目
init_project_if_required("/path/to/react-project", ".js,.jsx,.ts,.tsx")
```

项目初始化会自动创建：
- `.auto-coder/` 目录：存储配置和临时文件
- `actions/` 目录：存储 action 配置文件
- `.gitignore` 文件：添加必要的忽略规则
- `.autocoderignore` 文件：配置 auto-coder 忽略的文件

### 2. 命令行工具使用

#### 安装和基本使用

```bash
# 单次运行模式
auto-coder.run --model v3_chat "Write a function to calculate Fibonacci numbers" 

# 通过管道提供输入
echo "Explain this code" | auto-coder.run

# 指定输出格式
auto-coder.run  "Generate a hello world function" --output-format json

# 继续最近的对话
auto-coder.run --continue "继续修改xxxxx"

# Resume a specific conversation by session ID
auto-coder.run --resume 550e8400-e29b-41d4-a716-446655440000 "" 
```

#### 高级选项

```bash
# 设置最大对话轮数
auto-coder.run --max-turns 5 "Help me debug this code" 
```

### 3. Python API 使用

#### 基本查询

```python
import asyncio
from autocoder.sdk import query, query_sync, AutoCodeOptions, init_project_if_required

# 首先初始化项目（如果需要）
init_project_if_required(".", ".py,.ts")

# 同步查询
response = query_sync("Write a function to calculate Fibonacci numbers",options = AutoCodeOptions(                
        model="v3_chat"
    ))
print(response)

# 异步查询
async def async_example():
    options = AutoCodeOptions(                
        model="v3_chat"
    )
    
    async for message in query("Explain how Python decorators work", options):
        print(f"[{message.role}] {message.content}")

asyncio.run(async_example())
```

#### 流式查询示例

```python
import asyncio
from autocoder.sdk import query, AutoCodeOptions

async def stream_example():
    """异步流式查询示例"""
    options = AutoCodeOptions(
        model="deepseek/v3",
        max_turns=3
    )
    
    async for message in query("Write a hello world function", options):
        print(f"[{message.role}] {message.content}")

# 运行异步示例
asyncio.run(stream_example())
```

#### 同步查询示例

```python
from autocoder.sdk import query_sync, AutoCodeOptions

# 同步查询示例
options = AutoCodeOptions(
    model="deepseek/v3",
    max_turns=1
)

response = query_sync("Write a simple calculator function", options)
print(response)
```

#### 配置选项

```python
from autocoder.sdk import AutoCodeOptions, init_project_if_required

# 首先初始化项目（推荐）
init_project_if_required(".", ".py,.ts")

# 创建配置
options = AutoCodeOptions(
    max_turns=10,                    # 最大对话轮数
    system_prompt="You are a helpful coding assistant",  # 系统提示
    cwd="/path/to/project",          # 工作目录
    allowed_tools=["Read", "Write", "Bash"],  # 允许的工具
    permission_mode="acceptedits",    # 权限模式
    output_format="json",            # 输出格式
    stream=True,                     # 流式输出
    model="gpt-4",                   # 模型名称
    temperature=0.3,                 # 温度参数
    timeout=60,                      # 超时时间
    verbose=True,                    # 详细输出
    include_project_structure=True   # 包含项目结构
)

# 验证配置
options.validate()

# 转换为字典
config_dict = options.to_dict()

# 从字典创建
new_options = AutoCodeOptions.from_dict(config_dict)
```

## 核心组件详解

### 1. 主要 API 函数

**核心功能：**
- **query()**: 异步流式查询接口，返回消息流
- **query_sync()**: 同步查询接口，返回完整响应
- **init_project_if_required()**: 项目初始化函数

**主要方法：**
- `query(prompt, options=None, show_terminal=True) -> AsyncIterator[Message]`: 异步流式查询
- `query_sync(prompt, options=None, show_terminal=True) -> str`: 同步查询
- `init_project_if_required(target_dir, project_type=".py,.ts")`: 初始化项目

### 2. 数据模型

**核心数据结构：**
- **AutoCodeOptions**: 配置选项模型，包含所有可配置参数
- **Message**: 消息模型，表示对话中的单条消息
- **StreamEvent**: 流事件模型，用于流式响应
- **CodeModificationResult**: 代码修改结果模型

### 3. 会话管理

**会话相关类：**
- **Session**: 单个会话类，管理单次对话
- **SessionManager**: 会话管理器，管理多个会话

### 4. 异常处理

**自定义异常类：**
- **AutoCoderSDKError**: SDK 基础异常类
- **SessionNotFoundError**: 会话未找到异常
- **InvalidOptionsError**: 无效选项异常
- **BridgeError**: 桥接层异常
- **ValidationError**: 验证异常

## API 参考

### query() 函数

```python
async def query(
    prompt: str, 
    options: Optional[AutoCodeOptions] = None,
    show_terminal: bool = True
) -> AsyncIterator[Message]:
    """
    异步流式查询接口
    
    Args:
        prompt: 查询提示
        options: 配置选项
        show_terminal: 是否在终端显示友好的渲染输出
        
    Yields:
        Message: 响应消息流
    """
```

### query_sync() 函数

```python
def query_sync(
    prompt: str, 
    options: Optional[AutoCodeOptions] = None,
    show_terminal: bool = True
) -> str:
    """
    同步查询接口
    
    Args:
        prompt: 查询提示
        options: 配置选项
        show_terminal: 是否在终端显示友好的渲染输出
        
    Returns:
        str: 响应内容
    """
```

### init_project_if_required() 函数

```python
def init_project_if_required(target_dir: str, project_type: str = ".py,.ts"):
    """
    项目初始化函数
    
    Args:
        target_dir: 目标目录
        project_type: 项目类型，以逗号分隔的文件扩展名
    """
```

## 版本信息

- **当前版本**: 1.0.0
- **Python 版本要求**: 3.7+
- **主要依赖**: asyncio, typing

## 最佳实践

### 1. 项目初始化
在使用 SDK 之前，建议先调用 `init_project_if_required()` 初始化项目结构。

### 2. 异步编程
对于需要流式响应的场景，推荐使用 `query()` 异步函数。

### 3. 错误处理
使用 try-catch 块捕获和处理 SDK 异常。

### 4. 配置管理
使用 `AutoCodeOptions` 类统一管理配置选项。

## Mermaid 架构依赖图

```mermaid
graph TB
    %% 用户接口层
    UserAPI[用户 API<br/>query(), query_sync()]
    CLI[命令行工具<br/>auto-coder.run]
    
    %% SDK 入口
    SDKInit[__init__.py<br/>SDK 主入口]
    
    %% 核心层
    Core[AutoCoderCore<br/>核心封装类]
    Bridge[Bridge<br/>桥接层]
    
    %% 数据模型层
    Options[AutoCodeOptions<br/>配置选项]
    Messages[Message<br/>消息模型]
    Responses[StreamEvent<br/>响应模型]
    
    %% 会话管理层
    Session[Session<br/>单个会话]
    SessionMgr[SessionManager<br/>会话管理器]
    
    %% 工具层
    Utils[工具函数<br/>formatters, validators]
    IOUtils[IO工具<br/>输入输出处理]
    
    %% CLI 组件
    CLIMain[CLI Main<br/>主入口]
    CLIHandlers[CLI Handlers<br/>命令处理器]
    CLIFormatters[CLI Formatters<br/>输出格式化]
    
    %% 异常处理
    Exceptions[异常类<br/>SDK 异常体系]
    
    %% 外部依赖
    AutoCoderRunner[auto_coder_runner<br/>核心运行器]
    
    %% 依赖关系
    UserAPI --> SDKInit
    CLI --> CLIMain
    
    SDKInit --> Core
    SDKInit --> Options
    SDKInit --> Messages
    SDKInit --> Session
    SDKInit --> SessionMgr
    SDKInit --> Exceptions
    
    CLIMain --> CLIHandlers
    CLIMain --> CLIFormatters
    CLIMain --> Core
    
    Core --> Bridge
    Core --> Options
    Core --> Messages
    Core --> Responses
    Core --> Utils
    
    Bridge --> AutoCoderRunner
    
    Session --> Messages
    SessionMgr --> Session
    
    CLIHandlers --> Core
    CLIHandlers --> IOUtils
    
    %% 样式定义
    classDef userClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef coreClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef modelClass fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef utilClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px
    classDef extClass fill:#ffebee,stroke:#d32f2f,stroke-width:1px
    
    class UserAPI,CLI userClass
    class SDKInit,Core,Bridge coreClass
    class Options,Messages,Responses,Session,SessionMgr modelClass
    class Utils,IOUtils,CLIMain,CLIHandlers,CLIFormatters,Exceptions utilClass
    class AutoCoderRunner extClass
```

### 依赖关系说明

**用户接口层：**
- **UserAPI**: 提供 `query()` 和 `query_sync()` 函数供 Python 代码调用
- **CLI**: 提供命令行工具 `auto-coder.run` 供终端使用

**核心处理层：**
- **AutoCoderCore**: SDK 的核心封装类，处理所有业务逻辑
- **Bridge**: 桥接层，连接 SDK 和底层的 auto-coder 功能

**数据模型层：**
- **AutoCodeOptions**: 统一的配置选项管理
- **Message/StreamEvent**: 消息和响应的数据结构
- **Session/SessionManager**: 会话管理和状态维护

**工具支持层：**
- **Utils**: 提供格式化、验证等工具函数
- **CLI Components**: 命令行相关的处理和格式化组件
- **Exceptions**: 完整的异常处理体系

## 完整使用示例

### 示例 1：基本代码生成

```python
import asyncio
from autocoder.sdk import query_sync, AutoCodeOptions, init_project_if_required

# 初始化项目
init_project_if_required(".", ".py")

# 配置选项
options = AutoCodeOptions(
    model="deepseek/v3",
    max_turns=1,
    temperature=0.3
)

# 生成代码
response = query_sync(
    "Create a Python function to calculate the factorial of a number",
    options
)

print("Generated code:")
print(response)
```

### 示例 2：流式交互

```python
import asyncio
from autocoder.sdk import query, AutoCodeOptions

async def interactive_coding():
    options = AutoCodeOptions(
        model="deepseek/v3",
        max_turns=5,
        stream=True
    )
    
    print("Starting interactive coding session...")
    
    async for message in query(
        "Help me create a REST API using FastAPI with user authentication",
        options
    ):
        print(f"[{message.role}]: {message.content}")
        print("-" * 50)

# 运行交互式会话
asyncio.run(interactive_coding())
```

### 示例 3：错误处理

```python
from autocoder.sdk import query_sync, AutoCodeOptions
from autocoder.sdk import (
    AutoCoderSDKError,
    InvalidOptionsError,
    ValidationError
)

try:
    options = AutoCodeOptions(
        model="invalid-model",
        max_turns=-1  # 无效值
    )
    
    response = query_sync("Generate some code", options)
    
except InvalidOptionsError as e:
    print(f"配置错误: {e}")
except ValidationError as e:
    print(f"验证错误: {e}")
except AutoCoderSDKError as e:
    print(f"SDK 错误: {e}")
except Exception as e:
    print(f"未知错误: {e}")
```

## 故障排除

### 常见问题

1. **模型配置错误**
   ```
   错误：InvalidOptionsError: Model 'xxx' not found
   解决：检查 ~/.auto-coder/keys/models.json 中的模型配置
   ```

2. **API Key 问题**
   ```
   错误：Authentication failed
   解决：确保 API Key 文件存在且内容正确
   ```

3. **项目初始化失败**
   ```
   错误：Permission denied when creating .auto-coder directory
   解决：检查目录写权限，或使用 sudo 运行
   ```

4. **异步函数调用错误**
   ```
   错误：RuntimeError: asyncio.run() cannot be called from a running event loop
   解决：在 Jupyter 中使用 await，或使用 nest_asyncio
   ```

### 调试技巧

1. **启用详细日志**
   ```python
   options = AutoCodeOptions(
       model="deepseek/v3",
       verbose=True  # 启用详细输出
   )
   ```

2. **检查配置**
   ```python
   from autocoder.sdk import AutoCodeOptions
   
   options = AutoCodeOptions(model="deepseek/v3")
   print("配置有效性:", options.validate())
   print("配置内容:", options.to_dict())
   ```

3. **测试连接**
   ```bash
   # 使用命令行工具测试
   auto-coder.run --model deepseek/v3 "Hello world"
   ```

## 更新日志

### 版本 1.0.0
- 初始版本发布
- 提供 `query()` 和 `query_sync()` 核心 API
- 支持命令行工具 `auto-coder.run`
- 完整的配置选项和异常处理
- 会话管理功能
- 项目初始化工具



